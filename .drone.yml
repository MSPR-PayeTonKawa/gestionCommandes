kind: pipeline
type: kubernetes
name: GestionCommandes

platform:
  os: linux
  arch: amd64

steps:
- name: test
  image: golang
  commands:
  - go test

- name: sonar-scanner
  image: openjdk:11
  environment:
    SONAR_SCANNER_VERSION: 5.0.1.3006
    SONAR_SCANNER_HOME: /root/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux
    SONAR_TOKEN:
      from_secret: sonar_token
  commands:
  - curl --create-dirs -sSLo /root/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip
  - unzip -o /root/.sonar/sonar-scanner.zip -d /root/.sonar/
  - export PATH=$SONAR_SCANNER_HOME/bin:$PATH
  - export SONAR_SCANNER_OPTS="-server"
  - /root/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux/bin/sonar-scanner \
      -Dsonar.projectKey=MSPR-PayeTonKawa_gestionCommandes_909bdf9b-3c96-4895-9a16-4f87c5490a8f \
      -Dsonar.sources=. \
      -Dsonar.host.url=https://sonar.germainleignel.com

- name: docker
  image: plugins/docker
  settings:
    username:
      from_secret: harbor_username
    password:
      from_secret: harbor_password
    repo: registry.germainleignel.com/paye-ton-kawa/gestion-commandes
    registry: registry.germainleignel.com

trigger:
  branch:
  - main
