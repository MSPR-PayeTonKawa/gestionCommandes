kind: pipeline
type: docker
name: build-and-deploy
node:
  architecture: arm64

steps:
- name: build
  image: golang:1.22
  environment:
    DOCKER_REGISTRY: registry.germainleignel.com
    DOCKER_USERNAME:
      from_secret: DOCKER_USERNAME
    DOCKER_PASSWORD:
      from_secret: DOCKER_PASSWORD
    APPLICATION: gestion-commandes
  commands:
  - go mod download
  - CGO_ENABLED=0 GOOS=linux go build -o app main.go
  - docker build -t $DOCKER_REGISTRY/$DOCKER_USERNAME/$APPLICATION .
  - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD $DOCKER_REGISTRY
  - docker push $DOCKER_REGISTRY/$DOKCER_USERNAME/$APPLICATION
